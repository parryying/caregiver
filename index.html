<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caregiver Time Tracker | æŠ¤å·¥æ—¶é—´è¿½è¸ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: #2196F3;
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px 20px;
        }

        .caregiver-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .caregiver-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .status-in {
            background: #d4edda;
            color: #155724;
        }

        .status-out {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 18px 20px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        .btn-clock-in {
            background: #28a745;
            color: white;
        }

        .btn-clock-in:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-clock-out {
            background: #dc3545;
            color: white;
        }

        .btn-clock-out:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
            grid-column: 1 / -1;
        }

        .btn-edit:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .hours-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .hours-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .hours-number {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .hours-label {
            font-size: 14px;
            margin-top: 5px;
            line-height: 1.3;
        }

        .add-caregiver {
            text-align: center;
            margin-top: 30px;
        }

        .btn-add {
            background: #6f42c1;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
        }

        .btn-add:hover {
            background: #5a32a3;
        }

        .btn-settings {
            background: #17a2b8;
            color: white;
        }

        .btn-settings:hover {
            background: #138496;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            border-color: #2196F3;
            outline: none;
        }

        .btn-close {
            background: #6c757d;
            color: white;
        }

        .btn-close:hover {
            background: #545b62;
        }

        .caregiver-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .caregiver-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .caregiver-info {
            flex: 1;
        }

        .caregiver-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
            min-height: auto;
        }

        .current-time {
            text-align: center;
            font-size: 18px;
            margin-bottom: 25px;
            color: #666;
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .main-content {
                padding: 20px 15px;
            }
            
            .caregiver-card {
                padding: 20px;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            max-width: 300px;
            font-size: 14px;
            display: none;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .notification.warning {
            background: #ff9800;
        }

        .notification.success {
            background: #4caf50;
        }

        .notification.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Notification system -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <div class="header">
            <h1>Caregiver Time Tracker<br>æŠ¤å·¥æ—¶é—´è¿½è¸ª</h1>
            <div class="subtitle">Family Dashboard | å®¶åº­ç®¡ç†é¢æ¿</div>
        </div>

        <div class="main-content">
            <div class="current-time" id="currentTime">
                <!-- Current time will be inserted here -->
            </div>

            <!-- Management Buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <button class="btn btn-settings" onclick="openCaregiverManager()">
                    Manage Caregivers<br>ç®¡ç†æŠ¤å·¥
                </button>
                <button class="btn btn-settings" onclick="generateReport()">
                    Generate Report<br>ç”ŸæˆæŠ¥å‘Š
                </button>
            </div>

            <!-- Backup Management Section -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <button class="btn" style="background: #28a745; color: white;" onclick="downloadBackup()">
                    ğŸ“¥ Download Backup<br>ä¸‹è½½å¤‡ä»½
                </button>
                <button class="btn" style="background: #fd7e14; color: white;" onclick="showRestoreModal()">
                    ğŸ“¤ Restore Data<br>æ¢å¤æ•°æ®
                </button>
            </div>

            <!-- Caregiver Cards Container -->
            <div id="caregiversContainer">
                <!-- Caregiver cards will be dynamically generated here -->
            </div>

            <!-- Data Management Section -->
            <div class="data-section">
                <button class="btn btn-add" onclick="toggleDataView()" style="margin-bottom: 15px;">
                    View Time Logs | æŸ¥çœ‹æ—¶é—´è®°å½•
                </button>
                
                <div id="timeLogsView" style="display: none;">
                    <div class="caregiver-card">
                        <h3 style="margin-bottom: 15px;">Time Entries | æ—¶é—´è®°å½•</h3>
                        <div id="timeLogsList">
                            <!-- Time logs will be inserted here -->
                        </div>
                        <button class="btn" style="background: #dc3545; color: white; margin-top: 15px;" onclick="clearAllData()">
                            Clear All Data | æ¸…é™¤æ‰€æœ‰æ•°æ®
                        </button>
                        <button class="btn" style="background: #28a745; color: white; margin-top: 10px;" onclick="exportData()">
                            Export Data | å¯¼å‡ºæ•°æ®
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Caregiver Button -->
            <div class="add-caregiver">
                <button class="btn btn-add" onclick="addCaregiver()">
                    + Add Caregiver | + æ·»åŠ æŠ¤å·¥
                </button>
            </div>
        </div>
    </div>

    <!-- Caregiver Management Modal -->
    <div id="caregiverModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Manage Caregivers | ç®¡ç†æŠ¤å·¥</h2>
            
            <!-- Current Caregivers List -->
            <h3>Current Caregivers | å½“å‰æŠ¤å·¥</h3>
            <div class="caregiver-list" id="caregiversList">
                <!-- Populated by JavaScript -->
            </div>
            
            <!-- Add New Caregiver Form -->
            <h3>Add New Caregiver | æ·»åŠ æ–°æŠ¤å·¥</h3>
            <form id="caregiverForm" onsubmit="saveCaregiver(event)">
                <div class="form-group">
                    <label>English Name | è‹±æ–‡å§“å:</label>
                    <input type="text" id="englishName" required>
                </div>
                <div class="form-group">
                    <label>Chinese Name | ä¸­æ–‡å§“å:</label>
                    <input type="text" id="chineseName" required>
                </div>
                <div class="form-group">
                    <label>Monthly Hours | æœˆå·¥ä½œå°æ—¶:</label>
                    <input type="number" id="monthlyHours" min="1" max="744" value="160" required>
                </div>
                <div class="form-group">
                    <label>Hourly Rate | æ—¶è–ª ($):</label>
                    <input type="number" id="hourlyRate" min="0" step="0.01" value="25.00">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                    <button type="submit" class="btn btn-add">
                        Save | ä¿å­˜
                    </button>
                    <button type="button" class="btn btn-close" onclick="closeCaregiverModal()">
                        Close | å…³é—­
                    </button>
                </div>
            </form>
            
            <input type="hidden" id="editingCaregiverId" value="">
        </div>
    </div>

    <!-- Time Edit Modal -->
    <div id="timeEditModal" class="modal">
        <div class="modal-content">
            <h2>Edit Time Entry | ç¼–è¾‘æ—¶é—´è®°å½•</h2>
            
            <form id="timeEditForm" onsubmit="saveTimeEdit(event)">
                <div class="form-group">
                    <label>Clock In Date & Time | ä¸Šç­æ—¥æœŸæ—¶é—´:</label>
                    <input type="datetime-local" id="editClockIn" required>
                </div>
                <div class="form-group">
                    <label>Clock Out Date & Time | ä¸‹ç­æ—¥æœŸæ—¶é—´:</label>
                    <input type="datetime-local" id="editClockOut">
                </div>
                <div class="form-group">
                    <label>Notes | å¤‡æ³¨:</label>
                    <input type="text" id="editNotes">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                    <button type="submit" class="btn btn-add">
                        Save Changes | ä¿å­˜æ›´æ”¹
                    </button>
                    <button type="button" class="btn btn-close" onclick="closeTimeEditModal()">
                        Close | å…³é—­
                    </button>
                </div>
            </form>
            
            <input type="hidden" id="editingTimeEntryId" value="">
        </div>
    </div>

    <!-- Restore Data Modal -->
    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <h2>Restore Database | æ¢å¤æ•°æ®åº“</h2>
            <p style="color: #dc3545; font-weight: bold;">âš ï¸ Warning: This will replace ALL current data!</p>
            <p style="color: #dc3545;">è­¦å‘Šï¼šè¿™å°†æ›¿æ¢æ‰€æœ‰å½“å‰æ•°æ®ï¼</p>
            
            <div class="form-group">
                <label>Select Backup File | é€‰æ‹©å¤‡ä»½æ–‡ä»¶:</label>
                <input type="file" id="restoreFile" accept=".json" style="width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 8px;">
                <small style="color: #666;">Only JSON backup files are supported | ä»…æ”¯æŒJSONå¤‡ä»½æ–‡ä»¶</small>
            </div>
            
            <div id="restorePreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
                <h4>Backup Preview | å¤‡ä»½é¢„è§ˆ:</h4>
                <div id="restoreInfo"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                <button type="button" class="btn" style="background: #dc3545; color: white;" onclick="performRestore()" id="restoreBtn" disabled>
                    Restore Data | æ¢å¤æ•°æ®
                </button>
                <button type="button" class="btn btn-close" onclick="closeRestoreModal()">
                    Cancel | å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data structure and initialization
        let caregivers = [];
        let timeEntries = [];

        // API Helper Functions
        const API_BASE = window.location.origin;

        // Load data from API
        async function loadDataFromAPI() {
            try {
                caregivers = await apiCall('/caregivers');
                timeEntries = await apiCall('/time-entries');
                
                // Initialize with sample data if empty
                if (caregivers.length === 0) {
                    const sampleCaregiver = {
                        id: 'maria-' + Date.now(),
                        englishName: 'Maria Chen',
                        chineseName: 'é™ˆç›ä¸½äºš',
                        monthlyHours: 160,
                        hourlyRate: 25.00,
                        isActive: true
                    };
                    
                    await apiCall('/caregivers', {
                        method: 'POST',
                        body: JSON.stringify(sampleCaregiver)
                    });
                    
                    caregivers = [sampleCaregiver];
                }
                
                renderCaregiverCards();
            } catch (error) {
                console.error('Failed to load data from API:', error);
                alert('Failed to connect to server. Please check your internet connection.');
            }
        }

        // Current time display
        function updateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentTime').textContent = now.toLocaleDateString('en-US', options);
        }

        // Caregiver Management Functions
        function openCaregiverManager() {
            document.getElementById('caregiverModal').style.display = 'block';
            loadCaregiversList();
            clearCaregiverForm();
        }

        function closeCaregiverModal() {
            document.getElementById('caregiverModal').style.display = 'none';
        }

        function loadCaregiversList() {
            const list = document.getElementById('caregiversList');
            if (caregivers.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No caregivers added yet | æš‚æ— æŠ¤å·¥</p>';
                return;
            }

            let html = '';
            caregivers.forEach(caregiver => {
                const worked = calculateWorkedHours(caregiver.id);
                const remaining = Math.max(0, caregiver.monthlyHours - worked);
                
                html += `
                    <div class="caregiver-item">
                        <div class="caregiver-info">
                            <strong>${caregiver.englishName} | ${caregiver.chineseName}</strong><br>
                            <small>Monthly Hours | æœˆå°æ—¶: ${caregiver.monthlyHours}h | Rate | æ—¶è–ª: $${caregiver.hourlyRate}</small><br>
                            <small>Worked | å·²å·¥ä½œ: ${worked.toFixed(1)}h | Remaining | å‰©ä½™: ${remaining.toFixed(1)}h</small>
                        </div>
                        <div class="caregiver-actions">
                            <button class="btn btn-small" style="background: #ffc107;" onclick="editCaregiver('${caregiver.id}')">
                                Edit | ç¼–è¾‘
                            </button>
                            <button class="btn btn-small" style="background: #dc3545; color: white;" onclick="deleteCaregiver('${caregiver.id}')">
                                Delete | åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function saveCaregiver(event) {
            event.preventDefault();
            
            const englishName = document.getElementById('englishName').value;
            const chineseName = document.getElementById('chineseName').value;
            const monthlyHours = parseInt(document.getElementById('monthlyHours').value);
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
            const editingId = document.getElementById('editingCaregiverId').value;
            
            const caregiverData = {
                englishName,
                chineseName,
                monthlyHours,
                hourlyRate,
                isActive: true
            };
            
            if (editingId) {
                // Edit existing caregiver
                apiCall(`/caregivers/${editingId}`, {
                    method: 'PUT',
                    body: JSON.stringify(caregiverData)
                }).then(() => {
                    loadDataFromAPI();
                    loadCaregiversList();
                    clearCaregiverForm();
                }).catch(error => {
                    alert('Failed to update caregiver: ' + error.message);
                });
            } else {
                // Add new caregiver
                caregiverData.id = Date.now().toString();
                apiCall('/caregivers', {
                    method: 'POST',
                    body: JSON.stringify(caregiverData)
                }).then(() => {
                    loadDataFromAPI();
                    loadCaregiversList();
                    clearCaregiverForm();
                }).catch(error => {
                    alert('Failed to add caregiver: ' + error.message);
                });
            }
        }

        function editCaregiver(caregiverId) {
            const caregiver = caregivers.find(c => c.id === caregiverId);
            if (caregiver) {
                document.getElementById('englishName').value = caregiver.englishName;
                document.getElementById('chineseName').value = caregiver.chineseName;
                document.getElementById('monthlyHours').value = caregiver.monthlyHours;
                document.getElementById('hourlyRate').value = caregiver.hourlyRate;
                document.getElementById('editingCaregiverId').value = caregiverId;
            }
        }

        function deleteCaregiver(caregiverId) {
            if (confirm('Are you sure you want to delete this caregiver? This will also delete all their time entries.\nç¡®å®šè¦åˆ é™¤æ­¤æŠ¤å·¥å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤å…¶æ‰€æœ‰æ—¶é—´è®°å½•ã€‚')) {
                apiCall(`/caregivers/${caregiverId}`, {
                    method: 'DELETE'
                }).then(() => {
                    loadDataFromAPI();
                    loadCaregiversList();
                }).catch(error => {
                    alert('Failed to delete caregiver: ' + error.message);
                });
            }
        }

        function clearCaregiverForm() {
            document.getElementById('caregiverForm').reset();
            document.getElementById('editingCaregiverId').value = '';
            document.getElementById('monthlyHours').value = 160;
            document.getElementById('hourlyRate').value = 25.00;
        }

        // Dynamic caregiver card rendering
        function renderCaregiverCards() {
            const container = document.getElementById('caregiversContainer');
            
            if (caregivers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No caregivers added yet | æš‚æ— æŠ¤å·¥</h3>
                        <p>Click "Manage Caregivers" to add your first caregiver<br>ç‚¹å‡»"ç®¡ç†æŠ¤å·¥"æ·»åŠ ç¬¬ä¸€ä¸ªæŠ¤å·¥</p>
                    </div>
                `;
                return;
            }

            let html = '';
            caregivers.forEach(caregiver => {
                const currentEntry = getCurrentTimeEntry(caregiver.id);
                const isClocked = currentEntry !== null;
                const worked = calculateWorkedHours(caregiver.id);
                const remaining = Math.max(0, caregiver.monthlyHours - worked);
                
                html += `
                    <div class="caregiver-card">
                        <div class="caregiver-name">
                            ${caregiver.englishName} | ${caregiver.chineseName}
                        </div>
                        
                        <div class="status-badge ${isClocked ? 'status-in' : 'status-out'}" id="status-${caregiver.id}">
                            ${isClocked ? 'Clocked In | å·²ä¸Šç­' : 'Clocked Out | å·²ä¸‹ç­'}
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-clock-in" onclick="clockIn('${caregiver.id}')" ${isClocked ? 'disabled style="opacity: 0.5;"' : ''}>
                                Clock In<br>ä¸Šç­æ‰“å¡
                            </button>
                            <button class="btn btn-clock-out" onclick="clockOut('${caregiver.id}')" ${!isClocked ? 'disabled style="opacity: 0.5;"' : ''}>
                                Clock Out<br>ä¸‹ç­æ‰“å¡
                            </button>
                            <button class="btn btn-edit" onclick="showTimeEntries('${caregiver.id}')">
                                Edit Time | ç¼–è¾‘æ—¶é—´
                            </button>
                        </div>

                        <div class="hours-info">
                            <div class="hours-card">
                                <div class="hours-number" id="worked-${caregiver.id}">${worked.toFixed(1)}</div>
                                <div class="hours-label">Hours Worked<br>å·²å·¥ä½œå°æ—¶</div>
                            </div>
                            <div class="hours-card">
                                <div class="hours-number" id="remaining-${caregiver.id}">${remaining.toFixed(1)}</div>
                                <div class="hours-label">Hours Remaining<br>å‰©ä½™å°æ—¶</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Time tracking functions
        function clockIn(caregiverId) {
            // Check if already clocked in
            if (getCurrentTimeEntry(caregiverId)) {
                alert('Already clocked in | å·²ç»ä¸Šç­æ‰“å¡');
                return;
            }

            const now = new Date();
            const timeEntry = {
                caregiverId: caregiverId,
                clockIn: now.toISOString(),
                notes: ''
            };
            
            apiCall('/time-entries', {
                method: 'POST',
                body: JSON.stringify(timeEntry)
            }).then(() => {
                loadDataFromAPI();
                alert(`Clocked in at ${now.toLocaleTimeString()}\nä¸Šç­æ‰“å¡æ—¶é—´: ${now.toLocaleTimeString()}`);
            }).catch(error => {
                alert('Failed to clock in: ' + error.message);
            });
        }

        function clockOut(caregiverId) {
            const currentEntry = getCurrentTimeEntry(caregiverId);
            if (!currentEntry) {
                alert('Not currently clocked in | æœªä¸Šç­æ‰“å¡');
                return;
            }

            const now = new Date();
            
            apiCall(`/time-entries/${currentEntry.id}/clock-out`, {
                method: 'PATCH',
                body: JSON.stringify({
                    clockOut: now.toISOString()
                })
            }).then(() => {
                loadDataFromAPI();
                const clockIn = new Date(currentEntry.clockIn);
                const totalHours = (now - clockIn) / (1000 * 60 * 60);
                alert(`Clocked out at ${now.toLocaleTimeString()}\nTotal hours: ${totalHours.toFixed(2)}\nä¸‹ç­æ‰“å¡æ—¶é—´: ${now.toLocaleTimeString()}\næ€»å·¥ä½œæ—¶é—´: ${totalHours.toFixed(2)}å°æ—¶`);
            }).catch(error => {
                alert('Failed to clock out: ' + error.message);
            });
        }

        function getCurrentTimeEntry(caregiverId) {
            return timeEntries.find(entry => entry.caregiverId === caregiverId && !entry.clockOut) || null;
        }

        function calculateWorkedHours(caregiverId) {
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            return timeEntries
                .filter(entry => 
                    entry.caregiverId === caregiverId && 
                    entry.totalHours && 
                    entry.clockIn.startsWith(currentMonth)
                )
                .reduce((total, entry) => total + entry.totalHours, 0);
        }

        // Time editing functions
        function showTimeEntries(caregiverId) {
            const caregiver = caregivers.find(c => c.id === caregiverId);
            const entries = timeEntries.filter(e => e.caregiverId === caregiverId);
            
            if (entries.length === 0) {
                if (confirm('No time entries found for this caregiver. Would you like to add a manual entry?\næ­¤æŠ¤å·¥æš‚æ— æ—¶é—´è®°å½•ã€‚æ˜¯å¦è¦æ·»åŠ æ‰‹åŠ¨è®°å½•ï¼Ÿ')) {
                    addManualTimeEntry(caregiverId);
                }
                return;
            }
            
            let message = `Time Entries for ${caregiver.englishName} | ${caregiver.chineseName}:\n`;
            message += `æ—¶é—´è®°å½•:\n\n`;
            
            entries.forEach((entry, index) => {
                const clockIn = new Date(entry.clockIn);
                const clockOut = entry.clockOut ? new Date(entry.clockOut) : null;
                const duration = entry.totalHours ? entry.totalHours.toFixed(2) : 'In progress';
                
                message += `${index + 1}. ${clockIn.toLocaleDateString()} ${clockIn.toLocaleTimeString()}`;
                if (clockOut) {
                    message += ` â†’ ${clockOut.toLocaleTimeString()} (${duration}h)`;
                } else {
                    message += ` â†’ In progress | è¿›è¡Œä¸­`;
                }
                message += `\n`;
            });
            
            const action = prompt(message + '\nOptions | é€‰é¡¹:\n1. Add manual entry | æ·»åŠ æ‰‹åŠ¨è®°å½•\n2. Edit last entry | ç¼–è¾‘æœ€åè®°å½•\n3. Cancel | å–æ¶ˆ\n\nEnter 1, 2, or 3:');
            
            if (action === '1') {
                addManualTimeEntry(caregiverId);
            } else if (action === '2' && entries.length > 0) {
                editTimeEntry(entries[entries.length - 1]);
            }
        }

        function addManualTimeEntry(caregiverId) {
            document.getElementById('timeEditModal').style.display = 'block';
            document.getElementById('editingTimeEntryId').value = '';
            
            // Set default times (today 9 AM to 5 PM)
            const today = new Date();
            const clockIn = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 0);
            const clockOut = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 17, 0);
            
            document.getElementById('editClockIn').value = formatDateTimeLocal(clockIn);
            document.getElementById('editClockOut').value = formatDateTimeLocal(clockOut);
            document.getElementById('editNotes').value = '';
            
            // Store caregiver ID for saving
            window.currentEditingCaregiver = caregiverId;
        }

        function editTimeEntry(entry) {
            document.getElementById('timeEditModal').style.display = 'block';
            document.getElementById('editingTimeEntryId').value = entry.id;
            
            document.getElementById('editClockIn').value = formatDateTimeLocal(new Date(entry.clockIn));
            document.getElementById('editClockOut').value = entry.clockOut ? formatDateTimeLocal(new Date(entry.clockOut)) : '';
            document.getElementById('editNotes').value = entry.notes || '';
            
            window.currentEditingCaregiver = entry.caregiverId;
        }

        function saveTimeEdit(event) {
            event.preventDefault();
            
            const entryId = document.getElementById('editingTimeEntryId').value;
            const clockIn = new Date(document.getElementById('editClockIn').value);
            const clockOutValue = document.getElementById('editClockOut').value;
            const clockOut = clockOutValue ? new Date(clockOutValue) : null;
            const notes = document.getElementById('editNotes').value;
            
            if (clockOut && clockOut <= clockIn) {
                alert('Clock out time must be after clock in time | ä¸‹ç­æ—¶é—´å¿…é¡»æ™šäºä¸Šç­æ—¶é—´');
                return;
            }
            
            const timeEntryData = {
                clockIn: clockIn.toISOString(),
                clockOut: clockOut ? clockOut.toISOString() : null,
                notes
            };
            
            if (entryId) {
                // Edit existing entry
                apiCall(`/time-entries/${entryId}`, {
                    method: 'PUT',
                    body: JSON.stringify(timeEntryData)
                }).then(() => {
                    loadDataFromAPI();
                    closeTimeEditModal();
                    alert('Time entry saved successfully | æ—¶é—´è®°å½•ä¿å­˜æˆåŠŸ');
                }).catch(error => {
                    alert('Failed to save time entry: ' + error.message);
                });
            } else {
                // Add new entry
                timeEntryData.caregiverId = window.currentEditingCaregiver;
                apiCall('/time-entries', {
                    method: 'POST',
                    body: JSON.stringify(timeEntryData)
                }).then(() => {
                    loadDataFromAPI();
                    closeTimeEditModal();
                    alert('Time entry saved successfully | æ—¶é—´è®°å½•ä¿å­˜æˆåŠŸ');
                }).catch(error => {
                    alert('Failed to save time entry: ' + error.message);
                });
            }
        }

        function closeTimeEditModal() {
            document.getElementById('timeEditModal').style.display = 'none';
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Report generation
        function generateReport() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthName = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            
            let reportHtml = `
                <html>
                <head>
                    <title>Caregiver Report - ${monthName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { background-color: #f9f9f9; padding: 15px; margin: 20px 0; }
                        @media print { body { margin: 10px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Caregiver Time Report | æŠ¤å·¥æ—¶é—´æŠ¥å‘Š</h1>
                        <h2>${monthName}</h2>
                        <p>Generated on ${new Date().toLocaleDateString()} | ç”Ÿæˆæ—¥æœŸ: ${new Date().toLocaleDateString()}</p>
                    </div>
            `;
            
            caregivers.forEach(caregiver => {
                const entries = timeEntries.filter(e => e.caregiverId === caregiver.id && e.clockIn.startsWith(currentMonth));
                const totalWorked = entries.reduce((sum, e) => sum + (e.totalHours || 0), 0);
                const totalPay = totalWorked * caregiver.hourlyRate;
                
                reportHtml += `
                    <div class="summary">
                        <h3>${caregiver.englishName} | ${caregiver.chineseName}</h3>
                        <p>Monthly Allocation | æœˆåˆ†é…: ${caregiver.monthlyHours} hours | å°æ—¶</p>
                        <p>Hours Worked | å·²å·¥ä½œ: ${totalWorked.toFixed(2)} hours | å°æ—¶</p>
                        <p>Hours Remaining | å‰©ä½™: ${Math.max(0, caregiver.monthlyHours - totalWorked).toFixed(2)} hours | å°æ—¶</p>
                        <p>Total Pay | æ€»å·¥èµ„: $${totalPay.toFixed(2)} (@ $${caregiver.hourlyRate}/hour)</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date | æ—¥æœŸ</th>
                                <th>Clock In | ä¸Šç­</th>
                                <th>Clock Out | ä¸‹ç­</th>
                                <th>Hours | å°æ—¶</th>
                                <th>Notes | å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                entries.forEach(entry => {
                    const clockIn = new Date(entry.clockIn);
                    const clockOut = entry.clockOut ? new Date(entry.clockOut) : null;
                    
                    reportHtml += `
                        <tr>
                            <td>${clockIn.toLocaleDateString()}</td>
                            <td>${clockIn.toLocaleTimeString()}</td>
                            <td>${clockOut ? clockOut.toLocaleTimeString() : 'In Progress'}</td>
                            <td>${entry.totalHours ? entry.totalHours.toFixed(2) : '-'}</td>
                            <td>${entry.notes || '-'}</td>
                        </tr>
                    `;
                });
                
                reportHtml += '</tbody></table>';
            });
            
            reportHtml += '</body></html>';
            
            // Open in new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHtml);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                if (confirm('Print report now? | ç°åœ¨æ‰“å°æŠ¥å‘Šå—ï¼Ÿ')) {
                    printWindow.print();
                }
            }, 500);
        }
        function toggleDataView() {
            const dataView = document.getElementById('timeLogsView');
            if (dataView.style.display === 'none') {
                dataView.style.display = 'block';
                loadTimeLogsList();
            } else {
                dataView.style.display = 'none';
            }
        }

        function loadTimeLogsList() {
            const timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');
            const logsList = document.getElementById('timeLogsList');
            
            if (timeEntries.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #666;">No time entries yet | æš‚æ— æ—¶é—´è®°å½•</p>';
                return;
            }

            let html = '';
            timeEntries.forEach((entry, index) => {
                const clockIn = new Date(entry.clockIn);
                const clockOut = entry.clockOut ? new Date(entry.clockOut) : null;
                const duration = entry.totalHours ? entry.totalHours.toFixed(1) : 'In progress';
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <strong>${entry.caregiverId}</strong><br>
                        <small>Clock In | ä¸Šç­: ${clockIn.toLocaleString()}</small><br>
                        ${clockOut ? `<small>Clock Out | ä¸‹ç­: ${clockOut.toLocaleString()}</small><br>` : '<small style="color: #28a745;">Currently clocked in | æ­£åœ¨ä¸Šç­</small><br>'}
                        <small>Duration | æ—¶é•¿: ${duration} hours | å°æ—¶</small>
                    </div>
                `;
            });
            
            logsList.innerHTML = html;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.\nç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                localStorage.removeItem('timeEntries');
                localStorage.removeItem('caregivers');
                loadTimeLogsList();
                updateHoursDisplay('maria');
                alert('All data cleared | æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
            }
        }

        function exportData() {
            const timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');
            const caregivers = JSON.parse(localStorage.getItem('caregivers') || '[]');
            
            const data = {
                exportDate: new Date().toISOString(),
                timeEntries: timeEntries,
                caregivers: caregivers
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `caregiver-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Data exported successfully | æ•°æ®å¯¼å‡ºæˆåŠŸ');
        }

        // Data viewing functions
        function toggleDataView() {
            const dataView = document.getElementById('timeLogsView');
            if (dataView.style.display === 'none') {
                dataView.style.display = 'block';
                loadTimeLogsList();
            } else {
                dataView.style.display = 'none';
            }
        }

        function loadTimeLogsList() {
            const logsList = document.getElementById('timeLogsList');
            
            if (timeEntries.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #666;">No time entries yet | æš‚æ— æ—¶é—´è®°å½•</p>';
                return;
            }

            let html = '';
            timeEntries.forEach((entry, index) => {
                const caregiver = caregivers.find(c => c.id === entry.caregiverId);
                const caregiverName = caregiver ? `${caregiver.englishName} | ${caregiver.chineseName}` : entry.caregiverId;
                const clockIn = new Date(entry.clockIn);
                const clockOut = entry.clockOut ? new Date(entry.clockOut) : null;
                const duration = entry.totalHours ? entry.totalHours.toFixed(1) : 'In progress';
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <strong>${caregiverName}</strong><br>
                        <small>Clock In | ä¸Šç­: ${clockIn.toLocaleString()}</small><br>
                        ${clockOut ? `<small>Clock Out | ä¸‹ç­: ${clockOut.toLocaleString()}</small><br>` : '<small style="color: #28a745;">Currently clocked in | æ­£åœ¨ä¸Šç­</small><br>'}
                        <small>Duration | æ—¶é•¿: ${duration} hours | å°æ—¶</small><br>
                        ${entry.notes ? `<small>Notes | å¤‡æ³¨: ${entry.notes}</small><br>` : ''}
                        <button class="btn btn-small" style="background: #ffc107; margin-top: 5px;" onclick="editTimeEntry(${JSON.stringify(entry).replace(/"/g, '&quot;')})">
                            Edit | ç¼–è¾‘
                        </button>
                    </div>
                `;
            });
            
            logsList.innerHTML = html;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.\nç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                // Delete all time entries first
                Promise.all(timeEntries.map(entry => 
                    apiCall(`/time-entries/${entry.id}`, { method: 'DELETE' })
                )).then(() => {
                    // Then delete all caregivers
                    return Promise.all(caregivers.map(caregiver => 
                        apiCall(`/caregivers/${caregiver.id}`, { method: 'DELETE' })
                    ));
                }).then(() => {
                    loadDataFromAPI();
                    alert('All data cleared | æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
                }).catch(error => {
                    alert('Failed to clear data: ' + error.message);
                });
            }
        }

        function exportData() {
            const data = {
                exportDate: new Date().toISOString(),
                timeEntries: timeEntries,
                caregivers: caregivers
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `caregiver-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Data exported successfully | æ•°æ®å¯¼å‡ºæˆåŠŸ');
        }

        // Advanced Backup and Restore Functions
        function downloadBackup() {
            window.open(`${API_BASE}/api/backup`, '_blank');
        }

        function showRestoreModal() {
            document.getElementById('restoreModal').style.display = 'block';
            
            // Setup file input handler
            const fileInput = document.getElementById('restoreFile');
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file && file.type === 'application/json') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            showRestorePreview(backupData);
                        } catch (error) {
                            alert('Invalid backup file format | å¤‡ä»½æ–‡ä»¶æ ¼å¼æ— æ•ˆ');
                            fileInput.value = '';
                        }
                    };
                    reader.readAsText(file);
                } else {
                    alert('Please select a valid JSON backup file | è¯·é€‰æ‹©æœ‰æ•ˆçš„JSONå¤‡ä»½æ–‡ä»¶');
                    fileInput.value = '';
                }
            };
        }

        function showRestorePreview(backupData) {
            const preview = document.getElementById('restorePreview');
            const info = document.getElementById('restoreInfo');
            
            info.innerHTML = `
                <p><strong>Backup Date:</strong> ${new Date(backupData.timestamp).toLocaleString()}</p>
                <p><strong>Caregivers:</strong> ${backupData.totalCaregivers || backupData.caregivers?.length || 0}</p>
                <p><strong>Time Entries:</strong> ${backupData.totalTimeEntries || backupData.timeEntries?.length || 0}</p>
                <p><strong>Version:</strong> ${backupData.version || 'Unknown'}</p>
            `;
            
            preview.style.display = 'block';
            document.getElementById('restoreBtn').disabled = false;
            
            // Store backup data for restore
            window.pendingRestore = backupData;
        }

        async function performRestore() {
            if (!window.pendingRestore) {
                alert('No backup data loaded | æœªåŠ è½½å¤‡ä»½æ•°æ®');
                return;
            }

            if (!confirm('Are you sure you want to restore this backup? ALL current data will be lost!\nç¡®å®šè¦æ¢å¤æ­¤å¤‡ä»½å—ï¼Ÿæ‰€æœ‰å½“å‰æ•°æ®å°†ä¸¢å¤±ï¼')) {
                return;
            }

            try {
                await apiCall('/restore', {
                    method: 'POST',
                    body: JSON.stringify(window.pendingRestore)
                });

                alert('Database restored successfully! | æ•°æ®åº“æ¢å¤æˆåŠŸï¼');
                closeRestoreModal();
                loadDataFromAPI(); // Reload the UI
            } catch (error) {
                alert('Failed to restore backup: ' + error.message);
            }
        }

        function closeRestoreModal() {
            document.getElementById('restoreModal').style.display = 'none';
            document.getElementById('restoreFile').value = '';
            document.getElementById('restorePreview').style.display = 'none';
            document.getElementById('restoreBtn').disabled = true;
            window.pendingRestore = null;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const caregiverModal = document.getElementById('caregiverModal');
            const timeEditModal = document.getElementById('timeEditModal');
            const restoreModal = document.getElementById('restoreModal');
            
            if (event.target === caregiverModal) {
                closeCaregiverModal();
            }
            if (event.target === timeEditModal) {
                closeTimeEditModal();
            }
            if (event.target === restoreModal) {
                closeRestoreModal();
            }
        }

        // Initialize app
        function initializeApp() {
            updateTime();
            setInterval(updateTime, 60000); // Update every minute
            loadDataFromAPI(); // Load from API instead of localStorage
            checkBackupReminder(); // Check if backup reminder is needed
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Backup reminder system
        function checkBackupReminder() {
            const lastBackupReminder = localStorage.getItem('lastBackupReminder');
            const now = new Date();
            const reminderInterval = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
            
            if (!lastBackupReminder || (now.getTime() - parseInt(lastBackupReminder)) > reminderInterval) {
                setTimeout(() => {
                    showNotification(
                        'ğŸ’¾ Reminder: Consider downloading a backup of your data | æé†’ï¼šå»ºè®®ä¸‹è½½æ•°æ®å¤‡ä»½',
                        'warning',
                        10000
                    );
                }, 5000); // Show reminder 5 seconds after app loads
                
                localStorage.setItem('lastBackupReminder', now.getTime().toString());
            }
        }

        // Enhanced API call with better error handling and notifications
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                
                // Show appropriate error message
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showNotification('âš ï¸ Connection lost. Check your internet connection. | è¿æ¥ä¸¢å¤±ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚', 'error');
                } else {
                    showNotification(`âŒ Error: ${error.message}`, 'error');
                }
                
                throw error;
            }
        }

        // Start the app when page loads
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>